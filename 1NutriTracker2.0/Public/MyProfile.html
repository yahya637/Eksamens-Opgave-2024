<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile</title>
    <link rel="stylesheet" href="MyProfile.css">
</head>
<body>

<header class="hjem">
    <a href="NutriHome.html" class="logo">NutriTracker</a>
    <nav class="navbar">
        <div class="navbar-h">
            <a href="MealCreator2.0.html" id="nav-meal-creator">Meal Creator</a>
            <a href="MealTracker2.0.html">Meal Tracker</a>
            <a href="Daily.html">Daily Nutri</a>
            <a href="ActivityTracker.html">Activity Tracker</a>
            <a class="split" href="MyProfile.html">My Profile</a>
        </div>
    </nav>
</header>

<div>
  <div id="nutriHome">
      <div class="lo">
          <h1>My Profile</h1>
          <p>Manage your profile information and settings.</p>
          <p id="welcomeMessage"></p>
        </div>
    </div>
</div>

<div id="homeButtons">
    <form>
        <button type="button" id="manageProfileButton">Manage profile</button>
        <button type="button" id="deleteProfileButton">Delete Profile</button>
    </form>
</div>

<!-- Profile form -->
<div id="profileForm" style="display: none;">
    <form>
    <label id="usernameID">Username:</label>
    <input type="text" id="usernameInput" placeholder="Change Username" name="usernameS">
    
    <label id="emailID">Email:</label>
    <input type="text" id="emailInput" placeholder="Change Email" name="emailNameS">
    
    <label for="birthdate">Birthdate:</label>
    <input type="date" id="birthdate" name="birthdate">
    
    <label for="gender">Gender:</label>
    <select id="gender" name="gender">
    <option value="" disabled selected>Choose a gender</option>
    <option value="Man">Man</option>
    <option value="Woman">Woman</option>
    <option value="Other">Other</option>
    </select>
    <label for="'weight">Weight:</label>
    <input type="number" id="weight" placeholder="Weight in kg" name="weight">
    
    <button id="confirmButton">Confirm</button>
    </form>
</div>

<script>
// Skal omskrrives, dette er en test 
document.addEventListener('DOMContentLoaded', function () {
    displayWelcomeMessage();
});

function displayWelcomeMessage() {
    const welcomeMessage = document.getElementById('welcomeMessage');
    const username = localStorage.getItem('username');
    if (username) {
        welcomeMessage.textContent = `Welcome, ${username}!`;
    }
}

// Function to show/hide profile form
const profileForm = document.getElementById('profileForm');
const profileButton = document.getElementById('manageProfileButton');

function hideAndShowForm() {
    if (profileForm.style.display === 'none') {
        profileForm.style.display = 'block';
    } else {
        profileForm.style.display = 'none';
    }
}
profileButton.addEventListener('click', hideAndShowForm);

document.getElementById('deleteProfileButton').addEventListener('click', deleteProfile);

// Function to delete profile
function deleteProfile() {
    const userId = localStorage.getItem('userId');
    if (!userId) {
        alert('User not logged in');
        return;
    }

    if (confirm('Are you sure you want to delete your profile?')) {
        fetch(`/users/${userId}`, { method: 'DELETE' })
        .then(response => {
            if (response.ok) {
                alert('Profile deleted successfully');
                localStorage.removeItem('userId'); // Remove user_id from local storage
                window.location.href = "/NutriHome.html"; // Redirect the user
            } else {
                return response.json().then(data => {
                    throw new Error(data.message);
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete profile: ' + error.message);
        });
    }
}

async function updateUser(id, userData) {
  try {
    // Udfør PUT-anmodningen til API-endepunktet
    const response = await fetch(`/users/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(userData) // Konverter data til JSON-format
    });

    // Håndter svar fra serveren
    if (!response.ok) {
      throw new Error('Failed to update user profile');
    }

    // Hvis opdateringen lykkedes, returner svaret som JSON
    return response.json();
  } catch (error) {
    // Håndter eventuelle fejl under fetch-anmodningen
    console.error('Fetch error:', error);
    throw error;
  }
}

// Funktion til at opdatere profil
document.addEventListener('DOMContentLoaded', () => {
  // Funktion til at opdatere profil
  async function updateProfile() {
    const confirmButton = document.getElementById('confirmButton');
    confirmButton.addEventListener('click', async () => {
      const usernameInput = document.getElementById('usernameInput');
      const emailInput = document.getElementById('emailInput');
      const birthdateInput = document.getElementById('birthdate');
      const genderInput = document.getElementById('gender');
      const weightInput = document.getElementById('weight');

      const updatedUserData = {
        username: usernameInput.value,
        email: emailInput.value,
        birthdate: birthdateInput.value,
        gender: genderInput.value,
        weight: parseFloat(weightInput.value)
      };

      const userId = localStorage.getItem('userId');

      try {
        const response = await updateUser(userId, updatedUserData);
        
        console.log('Profile updated:', response); // Udskriv svar fra serveren i konsollen
        alert('Profile updated successfully');
        
        // Vent 1 sekund før genindlæsning af siden
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } catch (error) {
        console.error('Failed to update profile:', error);
        alert('Failed to update profile: ' + error.message);
      }
      finally {
        // Nulstil formularfelterne
        usernameInput.value = '';
        emailInput.value = '';
        birthdateInput.value = '';
        genderInput.value = '';
        weightInput.value = '';
      }
    });
  }

  // Kald funktionen for at initiere profilopdateringen
  updateProfile();
});
  
  </script>


</body>
</html>
